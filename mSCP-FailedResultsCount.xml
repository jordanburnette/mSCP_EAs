<?xml version="1.0" encoding="UTF-8"?>
<extensionAttribute>
<displayName>mSCP - Failed Results Count</displayName>
<displayInCategory>Operating System</displayInCategory>
<dataType>integer</dataType>
<description>Displays the number of compliance controls that failed.</description>
<scriptContentsMac>#!/bin/sh
######
# mSCP-FailedCount.sh
# Original by Matt Woodruff @ Jamf
# Last modified 2022.10.04 by Jordan Burnette
# https://github.com/jordanburnette/mSCP_EAs
###### Description
# Displays the number of compliance controls that failed.
######

audit=$(ls -l /Library/Preferences | /usr/bin/grep 'org.*.audit.plist' | /usr/bin/awk '{print $NF}')

if [[ ! -z "$audit" ]]; then

    count=$(echo "$audit" | wc -l | xargs)
	if [[ "$count" == 1 ]]; then
        
        # Get the Exemptions
        exemptfile="/Library/Managed Preferences/${audit}"
        if [[ ! -e "$exemptfile" ]];then
            exemptfile="/Library/Preferences/${audit}"
        fi

        /usr/bin/plutil -convert xml1 "${exemptfile}"

        exempt_rules=($(/usr/bin/defaults read "${exemptfile}" 2> /dev/null | /usr/bin/grep -B3 "exempt = 1" | /usr/bin/grep "{" | /usr/bin/cut -d '"' -f2 | /usr/bin/tail -n +2))

        # Get the Findings
        auditfile="/Library/Preferences/${audit}"
        /usr/bin/plutil -convert xml1 "${auditfile}"
    
        findings=($(/usr/bin/defaults read "${auditfile}" 2> /dev/null | /usr/bin/grep -B3 "finding = 1" | /usr/bin/grep "{" | /usr/bin/cut -d '"' -f2 | /usr/bin/tail -n +2))
        # count items only in Findings
        count=0
        for finding in ${findings[@]}; do
            if [[ ! " ${exempt_rules[*]} " =~ " ${finding} " ]] ;then
                ((count=count+1))
            fi
        done
    else
        count="-2"
    fi
else 
    count="-1"
fi

/bin/echo "&lt;result&gt;${count}&lt;/result&gt;"
</scriptContentsMac>
</extensionAttribute>
